version: 2.1
  
jobs:
  test:
    executor: runner
    steps:
      - run: |
          lscpu
          cat /sys/fs/cgroup/cpu.stat
          cat /sys/fs/cgroup/memory.stat

      - run:
          name: run usage commands
          command: |
            while true; do
              sleep 5
              echo "Mem Usage: "$(free | grep Mem | awk '{print $3/$2 * 100.0}')"%"
              echo "======"
              echo "CPU Usage: "$[100-$(vmstat 1 2|tail -1|awk '{print $15}')]"%"
              echo "======"
            done
          background: true
      - run:
          name: Profile CPU and memory every 5s (background)
          command: |
            while true; do
              sleep 5
              printf "\n\n$(date)\n"
              top -b -c -n 1
              echo "======"
            done
          background: true

      - checkout
      - run: 
          name: install some packages
          command: | 
            npm init -y
            npm i express cors
      - run: sleep 45
      - run: |
          lscpu
          cat /sys/fs/cgroup/cpu.max
          cat /sys/fs/cgroup/memory.max
          cat /sys/fs/cgroup/memory.high
workflows:
  main:
    jobs:
      - test

executors:
  runner:
    docker:
      - image: cimg/node:lts
    resource_class: ryanpedersen/container-runner-local

# VS Code Extension Version: 1.0.0